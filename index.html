<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Household Budget App</title>
  
  <!-- CSS Framework: Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js for Donut Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f5f5f4; /* stone-100 */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #44403c; /* stone-700 */
    }
    
    /* Navigation Active State */
    .nav-item.active {
      color: #0f766e; /* teal-700 */
    }
    .nav-item.active svg {
      stroke-width: 2.5px;
    }

    /* Subtab Active State */
    .subtab.active {
      background-color: #ffffff;
      color: #1c1917; /* stone-900 */
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 700;
    }
    .subtab {
      color: #78716c; /* stone-500 */
      font-weight: 500;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      width: 100%;
      height: 240px;
      margin: 0 auto;
    }

    /* Hide scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* View transitions */
    .view {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }
    .view.active { display: block; }
    
    .panel {
      display: none;
      animation: fadeIn 0.2s ease-out;
    }
    .panel.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Bottom Nav Padding */
    .nav-bar {
      padding-top: 10px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }
  </style>
</head>
<body class="antialiased selection:bg-teal-100">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-md shadow-sm border-b border-stone-200 p-4 fixed top-0 w-full z-20 flex justify-center items-center h-14">
    <h1 class="text-lg font-bold text-stone-800 tracking-tight" id="header-title">ãƒ›ãƒ¼ãƒ </h1>
  </header>

  <main class="mt-14 container mx-auto max-w-md relative">

    <!-- ==============================
         VIEW 1: HOME (DASHBOARD)
         ============================== -->
    <div id="view-home" class="view active px-4 pt-4 pb-40 space-y-5">
      
      <!-- Subtabs for Home -->
      <div class="bg-stone-200/80 p-1 rounded-xl flex gap-1 shadow-inner">
        <button id="subtab-spend" class="subtab active flex-1 py-2 text-sm rounded-lg transition-all" onclick="switchHomePanel('spend')">
          æ”¯å‡ºçŠ¶æ³
        </button>
        <button id="subtab-asset" class="subtab flex-1 py-2 text-sm rounded-lg transition-all" onclick="switchHomePanel('asset')">
          è³‡ç”£çŠ¶æ³
        </button>
      </div>

      <!-- PANEL A: SPEND (æ”¯å‡ºçŠ¶æ³) -->
      <div id="panel-spend" class="panel active space-y-6">
        
        <!-- Detailed Donut Chart Section -->
        <section class="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
          <div class="flex justify-between items-end mb-3">
            <h2 class="text-stone-800 font-bold">æ”¯å‡ºã®å†…è¨³ã¨è²¯è“„</h2>
          </div>
          <div class="chart-container">
            <canvas id="spendChart"></canvas>
            <!-- Center Text inside Donut -->
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-2">
              <span class="text-xs font-bold text-stone-400 mb-0.5">ç¾åœ¨ã®ç·æ”¯å‡º</span>
              <span class="text-3xl font-bold text-stone-800 tracking-tight" id="chart-total-spend">Â¥---</span>
              <span class="text-xs font-bold text-blue-600 mt-1 bg-blue-50 px-2.5 py-0.5 rounded-full border border-blue-100" id="chart-savings-text">è²¯è“„: Â¥---</span>
            </div>
          </div>
        </section>

        <!-- Category Budgets Section (Accordion Style) -->
        <section>
          <div class="flex justify-between items-end mb-3 px-1">
            <h2 class="text-stone-800 font-bold">é …ç›®åˆ¥ äºˆç®—æ¶ˆåŒ–</h2>
          </div>
          <div id="budget-list">
            <!-- JSã§ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å½¢å¼ã®ã‚«ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ -->
            <p class="text-center text-stone-400 text-sm py-4">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
          </div>
        </section>
      </div>

      <!-- PANEL B: ASSET (è³‡ç”£çŠ¶æ³) -->
      <div id="panel-asset" class="panel space-y-5">
        
        <!-- Asset Donut Chart Section -->
        <section class="bg-white rounded-2xl p-5 shadow-sm border border-stone-200">
          <div class="flex justify-between items-end mb-4">
            <h2 class="text-stone-800 font-bold">ç·è³‡ç”£ã®å†…è¨³</h2>
          </div>
          <div class="chart-container mb-2">
            <canvas id="assetChart"></canvas>
            <!-- Center Text inside Donut -->
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-2">
              <span class="text-xs font-bold text-stone-400 mb-0.5">ç¾åœ¨ã®ç·è³‡ç”£</span>
              <span class="text-3xl font-bold text-stone-800 tracking-tight" id="chart-total-asset">Â¥---</span>
            </div>
          </div>
          
          <!-- Asset Details List -->
          <div id="asset-list" class="space-y-3 mt-6 border-t border-stone-100 pt-5 px-1">
            <p class="text-center text-stone-400 text-sm py-4">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
          </div>
        </section>
        
      </div>
    </div>

    <!-- ==============================
         VIEW 2: INPUT (ADD)
         ============================== -->
    <div id="view-add" class="view px-4 pt-4 pb-40 space-y-5">
      
      <!-- å…¥åŠ›ç”»é¢ã®ã‚µãƒ–ã‚¿ãƒ– -->
      <div class="bg-stone-200/80 p-1 rounded-xl flex gap-1 shadow-inner">
        <button id="subtab-auto" class="subtab active flex-1 py-2 text-sm rounded-lg transition-all" onclick="switchAddPanel('auto')">
          ã‚«ãƒ¼ãƒ‰ã®ç¢ºèª
        </button>
        <button id="subtab-manual" class="subtab flex-1 py-2 text-sm rounded-lg transition-all" onclick="switchAddPanel('manual')">
          æ–°è¦æ‰‹å…¥åŠ›
        </button>
      </div>

      <!-- PANEL C: AUTO INPUT (ã‚«ãƒ¼ãƒ‰ã®è£œå®Œ) -->
      <div id="panel-auto" class="panel active space-y-6">
        <section class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
          <div class="bg-red-50 p-4 border-b border-red-100 flex justify-between items-center">
            <h2 class="text-red-800 font-bold flex items-center gap-2">
              <span class="text-lg">ğŸ’³</span> è‡ªå‹•è¨˜éŒ²ã®ç¢ºèª
            </h2>
            <span class="text-xs bg-white text-red-500 px-2 py-1 rounded-full font-bold shadow-sm border border-red-200" id="badge-incomplete">0</span>
          </div>
          <div id="incomplete-container" class="p-4 space-y-4 bg-stone-50/50">
            <p class="text-stone-400 text-sm text-center py-2">æœªç¢ºèªã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        </section>
      </div>

      <!-- PANEL D: MANUAL INPUT (å®Œå…¨æ‰‹å…¥åŠ›) -->
      <div id="panel-manual" class="panel space-y-6">
        <section class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
          <div class="bg-teal-50 p-4 border-b border-teal-100">
            <h2 class="text-teal-800 font-bold flex items-center gap-2">
              <span class="text-lg">âœï¸</span> æ‰‹å…¥åŠ› (PayPayç­‰)
            </h2>
          </div>
          <div class="p-5">
            <form onsubmit="submitManual(event)" class="space-y-4">
              <div>
                <label class="block text-xs font-bold text-stone-500 mb-1">æ—¥ä»˜</label>
                <input type="date" id="input-date" required class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-teal-500 outline-none">
              </div>
              <div>
                <label class="block text-xs font-bold text-stone-500 mb-1">é‡‘é¡</label>
                <input type="number" id="input-amount" placeholder="Â¥" required class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-teal-500 outline-none">
              </div>
              <div>
                <label class="block text-xs font-bold text-stone-500 mb-1">é …ç›®</label>
                <select id="input-item" required class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-teal-500 outline-none">
                  <option value="">èª­è¾¼ä¸­...</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-stone-500 mb-1">æ”¯æ‰•æ–¹æ³•</label>
                <select id="input-app" class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-teal-500 outline-none">
                  <option value="æ”¯å‡ºãƒ»Paypayã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ">Paypayã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</option>
                  <option value="æ”¯å‡ºãƒ»ç¾é‡‘">ç¾é‡‘</option>
                  <option value="æ”¯å‡ºãƒ»ãƒ‡ãƒ“ãƒƒãƒˆ">ãƒ‡ãƒ“ãƒƒãƒˆ</option>
                  <option value="æ”¯å‡ºãƒ»Paypay">Paypay</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-stone-500 mb-1">ãƒ¡ãƒ¢ (ä»»æ„)</label>
                <input type="text" id="input-memo" placeholder="è©³ç´°ã‚’å…¥åŠ›..." class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-teal-500 outline-none">
              </div>
              <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3.5 rounded-xl shadow-md transition-all active:scale-95 mt-2">
                è¿½åŠ ã™ã‚‹
              </button>
            </form>
          </div>
        </section>
      </div>

    </div>

  </main>

  <!-- Bottom Navigation -->
  <nav class="bg-white/95 backdrop-blur border-t border-stone-200 fixed bottom-0 w-full flex justify-around items-center z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] nav-bar">
    <button onclick="switchTab('home')" id="tab-home" class="nav-item tab-active flex flex-col items-center justify-center w-1/2 py-1 gap-1 text-teal-700 transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
      <span class="text-[10px] font-medium">ãƒ›ãƒ¼ãƒ </span>
    </button>
    <button onclick="switchTab('add')" id="tab-add" class="nav-item flex flex-col items-center justify-center w-1/2 py-1 gap-1 text-stone-400 transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
      <span class="text-[10px] font-medium">å…¥åŠ›</span>
    </button>
  </nav>

  <!-- Application Logic -->
  <script>
    let globalItems = [];
    let globalTimeline = []; 
    let spendChartInstance = null;
    let assetChartInstance = null;

    // --- Color Palettes ---
    const SPEND_COLORS = [
      '#f87171', '#fb923c', '#fbbf24', '#facc15', '#a3e635', 
      '#4ade80', '#34d399', '#2dd4bf', '#22d3ee', '#94a3b8'
    ];
    const SAVINGS_COLOR = '#3b82f6';
    const ASSET_COLORS = ['#0f766e', '#059669', '#2563eb', '#7c3aed'];

    // --- MOCK DATA FOR PREVIEW ---
    const MOCK_DATA = {
      spendBreakdown: {
        totalSpend: 135000, savings: 65000,
        items: [
          { name: "é£Ÿè²»", amount: 12000 }, { name: "å¤–é£Ÿè²»", amount: 18000 },
          { name: "äº¤éš›è²»", amount: 15000 }, { name: "è¢«æœãƒ»ç¾å®¹", amount: 10000 },
          { name: "å›ºå®šè²»", amount: 50000 }
        ]
      },
      assets: {
        totalAsset: 3800000,
        items: [ { name: "ä¸‰äº•ä½å‹éŠ€è¡Œ", amount: 1500000 }, { name: "ç©ç«‹ï¼®ï¼©ï¼³ï¼¡", amount: 1200000 } ]
      },
      budgets: [
        { name: "é£Ÿè²»", budget: 40000, current: 30000 },
        { name: "äº¤éš›è²»", budget: 20000, current: 15000 },
        { name: "è¢«æœãƒ»ç¾å®¹", budget: 10000, current: 10000 }
      ],
      timeline: [
        { date: "2/23", category: "æ”¯å‡ºãƒ»Paypay", item: "é£Ÿè²»", amount: 3450, app: "Paypay", memo: "ã‚¹ãƒ¼ãƒ‘ãƒ¼" },
        { date: "2/21", category: "æ”¯å‡ºãƒ»ç¾é‡‘", item: "äº¤éš›è²»", amount: 1200, app: "ç¾é‡‘", memo: "å‹äººAã¨ãƒ©ãƒ³ãƒ" },
        { date: "2/20", category: "æ”¯å‡ºãƒ»ã‚«ãƒ¼ãƒ‰", item: "é£Ÿè²»", amount: 800, app: "ã‚«ãƒ¼ãƒ‰", memo: "ã‚³ãƒ³ãƒ“ãƒ‹" }
      ],
      incomplete: [ { rowNum: 20, date: "2/23", amount: 1200 } ],
      items: ["é£Ÿè²»", "å¤–é£Ÿè²»", "å¨¯æ¥½", "åŒ»ç™‚è²»", "äº¤é€šè²»", "æ—¥ç”¨å“è²»", "äº¤éš›è²»", "è¢«æœãƒ»ç¾å®¹", "å›ºå®šè²»", "ãã®ä»–"]
    };

    // --- Tab & Panel Switching ---
    function switchTab(tabName) {
      document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.remove('active', 'tab-active', 'text-teal-700');
        btn.classList.add('text-stone-400');
      });

      document.getElementById('view-' + tabName).classList.add('active');
      const activeBtn = document.getElementById('tab-' + tabName);
      activeBtn.classList.remove('text-stone-400');
      activeBtn.classList.add('active', 'text-teal-700');

      const titles = { 'home': 'ãƒ›ãƒ¼ãƒ ', 'add': 'æ”¯å‡ºã®å…¥åŠ›' };
      document.getElementById('header-title').innerText = titles[tabName];
    }

    function switchHomePanel(panelName) {
      document.querySelectorAll('#view-home .panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('#view-home .subtab').forEach(t => t.classList.remove('active'));
      document.getElementById('panel-' + panelName).classList.add('active');
      document.getElementById('subtab-' + panelName).classList.add('active');
    }

    function switchAddPanel(panelName) {
      document.querySelectorAll('#view-add .panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('#view-add .subtab').forEach(t => t.classList.remove('active'));
      document.getElementById('panel-' + panelName).classList.add('active');
      document.getElementById('subtab-' + panelName).classList.add('active');
    }

    // --- Initialization ---
    // ==========================================
    // APIé€šä¿¡ç”¨è¨­å®šï¼ˆâ˜…ã“ã“ã«GASã®URLã‚’è²¼ã‚‹ï¼‰
    // ==========================================
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiw2An9zGShvooxk6d_SLZUo0mAcx4rmoeTnSclXTQEshaAQC_-0ycq5sXhYtbu58L6Q/exec';

    // å…±é€šã®APIå‘¼ã³å‡ºã—é–¢æ•°
    async function fetchAPI(action, payload = {}) {
      const res = await fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        redirect: 'follow', // GASã®ä»•æ§˜ä¸Šå¿…é ˆ
        headers: {
          'Content-Type': 'text/plain', // CORSã‚¨ãƒ©ãƒ¼å›é¿ã®ãŠã¾ã˜ãªã„
        },
        body: JSON.stringify({ action: action, ...payload })
      });
      const json = await res.json();
      if (json.status === 'error') throw new Error(json.message);
      return json.data;
    }

    // --- Initialization ---
    window.onload = function() {
      document.getElementById('input-date').valueAsDate = new Date();
      loadAllData();
    };

    // â˜…ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ã§èª­ã¿è¾¼ã‚€ï¼ˆçˆ†é€ŸåŒ–ï¼‰
    async function loadAllData() {
      try {
        const data = await fetchAPI('getAllData');
        
        updateSpendChartUI(data.spend);
        updateAssetChartUI(data.asset);
        storeTimelineData(data.timeline);
        updateBudgets(data.budgets);
        
        globalItems = data.items;
        initSelect('input-item', data.items);
        updateIncompleteForms(data.incomplete);
      } catch (error) {
        showError(error);
      }
    }

    // --- UI Update Functions
    function updateSpendChartUI(data) { 
      if(!data) return;
      document.getElementById('chart-total-spend').innerText = 'Â¥ ' + data.totalSpend.toLocaleString();
      document.getElementById('chart-savings-text').innerText = 'è²¯è“„: Â¥ ' + data.savings.toLocaleString();
      const labels = data.items.map(i => i.name).concat(['è²¯è“„']);
      const amounts = data.items.map(i => i.amount).concat([data.savings]);
      const colors = SPEND_COLORS.slice(0, data.items.length).concat([SAVINGS_COLOR]);
      if (spendChartInstance) spendChartInstance.destroy();
      const ctx = document.getElementById('spendChart').getContext('2d');
      spendChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ data: amounts, backgroundColor: colors, borderWidth: 2, borderColor: '#ffffff', hoverOffset: 4 }] },
        options: { cutout: '72%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return ' ' + context.label + ': Â¥' + context.raw.toLocaleString(); } } } } }
      });
    }

    function updateAssetChartUI(data) { 
      if(!data) return;
      document.getElementById('chart-total-asset').innerText = 'Â¥ ' + data.totalAsset.toLocaleString();
      const labels = data.items.map(i => i.name);
      const amounts = data.items.map(i => i.amount);
      if (assetChartInstance) assetChartInstance.destroy();
      const ctx = document.getElementById('assetChart').getContext('2d');
      assetChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: labels, datasets: [{ data: amounts, backgroundColor: ASSET_COLORS, borderWidth: 2, borderColor: '#ffffff', hoverOffset: 4 }] },
        options: { cutout: '72%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return ' ' + context.label + ': Â¥' + context.raw.toLocaleString(); } } } } }
      });
      let html = '';
      data.items.forEach((item, i) => {
        let color = ASSET_COLORS[i % ASSET_COLORS.length];
        html += `<div class="flex justify-between items-center text-sm mb-1.5"><div class="flex items-center gap-2"><span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background-color: ${color}"></span><span class="text-stone-600 font-bold">${item.name}</span></div><span class="font-bold text-stone-800 text-base tracking-tight">Â¥ ${item.amount.toLocaleString()}</span></div>`;
      });
      document.getElementById('asset-list').innerHTML = html;
    }

    function storeTimelineData(data) { globalTimeline = data || []; }

    function updateBudgets(data) { 
      const container = document.getElementById('budget-list');
      if (!data || data.length === 0) return;
      let html = '<div class="space-y-3">';
      data.forEach((item, index) => {
        let pct = item.budget > 0 ? Math.floor((item.current / item.budget) * 100) : (item.current > 0 ? 100 : 0);
        let isOver = item.current > item.budget;
        let colorClass = isOver ? 'bg-red-500' : 'bg-teal-500';
        let remainingText = isOver ? `<span class="text-red-500 font-bold">Â¥${(item.current - item.budget).toLocaleString()} ã‚ªãƒ¼ãƒãƒ¼</span>` : `æ®‹ã‚Š Â¥${(item.budget - item.current).toLocaleString()}`;
        html += `<div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden transition-all duration-300"><div class="p-4 cursor-pointer active:bg-stone-50 select-none" onclick="toggleDetails(${index}, '${item.name}')"><div class="flex justify-between items-baseline mb-2"><h2 class="font-bold text-stone-800">${item.name}</h2><span class="text-xs text-stone-500 font-medium">${remainingText}</span></div><div class="w-full bg-stone-100 rounded-full h-2.5 mb-2 overflow-hidden"><div class="${colorClass} h-2.5 rounded-full transition-all duration-1000" style="width: ${Math.min(pct, 100)}%"></div></div><div class="flex justify-between items-center text-[11px] text-stone-400 mt-1"><div><span>ä½¿ç”¨: Â¥${item.current.toLocaleString()}</span><span class="mx-1">/</span><span>äºˆç®—: Â¥${item.budget.toLocaleString()}</span></div><div class="bg-stone-100 p-0.5 rounded text-stone-500"><svg id="icon-${index}" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg></div></div></div><div id="details-${index}" class="hidden bg-stone-50 border-t border-stone-100 p-3 max-h-60 overflow-y-auto"></div></div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function toggleDetails(index, categoryName) { 
      const detailsDiv = document.getElementById(`details-${index}`);
      const icon = document.getElementById(`icon-${index}`);
      if (!detailsDiv.classList.contains('hidden')) { detailsDiv.classList.add('hidden'); icon.classList.remove('rotate-180'); return; }
      detailsDiv.classList.remove('hidden'); icon.classList.add('rotate-180');
      const filtered = globalTimeline.filter(t => t.item === categoryName || categoryName.includes(t.item));
      if (filtered.length === 0) { detailsDiv.innerHTML = '<p class="text-center text-stone-400 text-xs py-3">ã“ã®é …ç›®ã®æ˜ç´°ã¯ã‚ã‚Šã¾ã›ã‚“</p>'; } else {
        let detailHtml = '<div class="space-y-2">';
        filtered.forEach(t => {
          let memoText = t.memo ? `<span class="text-stone-500 text-[14px] truncate max-w-[100px] inline-block align-bottom ml-1">${t.memo}</span>` : '';
          detailHtml += `<div class="flex justify-between items-center bg-white p-2.5 rounded-lg border border-stone-100 shadow-sm"><div class="flex-1 overflow-hidden pr-2"><p class="text-xs font-bold text-stone-700 whitespace-nowrap overflow-hidden text-ellipsis">${t.date} <span class="font-normal text-stone-500 ml-1 text-[10px]">${t.category || ''}</span></p><p class="text-[14px] text-stone-500 mt-0.5 truncate">${memoText}</p></div><p class="text-sm font-bold text-stone-800 shrink-0">-Â¥${t.amount.toLocaleString()}</p></div>`;
        });
        detailHtml += '</div>'; detailsDiv.innerHTML = detailHtml;
      }
    }

    function initSelect(id, items) { 
      const select = document.getElementById(id);
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
      items.forEach(item => { select.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    function updateIncompleteForms(data) { 
      const container = document.getElementById('incomplete-container');
      const badge = document.getElementById('badge-incomplete');
      badge.innerText = data ? data.length : 0;
      if (!data || data.length === 0) { container.innerHTML = '<div class="text-center py-6"><p class="text-2xl mb-2">âœ¨</p><p class="text-stone-400 text-sm font-medium">å…¨ã¦ç¢ºèªæ¸ˆã¿ã§ã™</p></div>'; return; }
      let optionsHtml = '<option value="">é …ç›®ã‚’é¸æŠ</option>';
      if (globalItems) { globalItems.forEach(opt => optionsHtml += `<option value="${opt}">${opt}</option>`); }
      let html = '';
      data.forEach(item => {
        html += `<div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm relative" id="inc-form-${item.rowNum}"><div class="flex justify-between items-start mb-3"><div><span class="text-xs font-bold text-red-400 block mb-0.5">è‡ªå‹•è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿</span><span class="text-sm font-bold text-stone-700">${item.date}</span></div><span class="font-bold text-red-600 text-xl tracking-tight">Â¥ ${item.amount.toLocaleString()}</span></div><div class="space-y-3 mb-4"><select id="inc-item-${item.rowNum}" class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-red-400" required>${optionsHtml}</select><input type="text" id="inc-memo-${item.rowNum}" placeholder="ãƒ¡ãƒ¢ (ä»»æ„)" class="w-full bg-stone-50 border border-stone-200 rounded-lg p-2.5 text-sm outline-none focus:border-red-400"></div><button onclick="submitIncomplete(${item.rowNum})" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold shadow-md transition-all active:scale-95 text-sm">TRUEã«ã—ã¦ä¿å­˜</button></div>`;
      });
      container.innerHTML = html;
    }

    function showError(error) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼:\n" + (error.message || error)); }

    // â˜… è‡ªå‹•è¨˜éŒ²é€ä¿¡å‡¦ç†
    async function submitIncomplete(rowNum) {
      const item = document.getElementById(`inc-item-${rowNum}`).value;
      const memo = document.getElementById(`inc-memo-${rowNum}`).value;
      if (!item) return alert("é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„");

      const btn = document.querySelector(`#inc-form-${rowNum} button`);
      btn.innerText = 'é€ä¿¡ä¸­...';
      btn.disabled = true;
      btn.classList.add('opacity-50');

      try {
        await fetchAPI('updateIncompleteRecord', { rowNum, item, memo });
        await loadAllData(); // æˆåŠŸã—ãŸã‚‰ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      } catch (error) {
        showError(error);
        btn.innerText = 'TRUEã«ã—ã¦ä¿å­˜';
        btn.disabled = false;
        btn.classList.remove('opacity-50');
      }
    }

    // â˜… æ‰‹å…¥åŠ›é€ä¿¡å‡¦ç†
    async function submitManual(e) {
      e.preventDefault();
      const date = document.getElementById('input-date').value;
      const amount = document.getElementById('input-amount').value;
      const item = document.getElementById('input-item').value;
      const app = document.getElementById('input-app').value;
      const memo = document.getElementById('input-memo').value;

      if (!item) return alert("é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„");

      const btn = e.target.querySelector('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'é€ä¿¡ä¸­...';
      btn.disabled = true;

      try {
        await fetchAPI('addManualRecord', { date, item, amount, app, memo });
        alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
        e.target.reset();
        document.getElementById('input-date').valueAsDate = new Date();
        await loadAllData(); // æˆåŠŸã—ãŸã‚‰ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
      } catch (error) {
        showError(error);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
